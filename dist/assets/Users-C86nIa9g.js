import{r,j as a}from"./index-CSak_wTG.js";import{c as w,s as i}from"./createLucideIcon-6Q1StMY_.js";import{u as I}from"./ToastContext-ykpRnyEW.js";import{I as N}from"./constants-Czdmcpm8.js";import{a as K,h as X}from"./helpers-BFGMH2X3.js";import{P as V,a as J,T as O}from"./trash-2-CPYBQgyF.js";import{S as Q}from"./search-BDv52CUj.js";import{U as W}from"./users-CqfQCxuk.js";import{S as Y,K as Z}from"./shield-C_HhIGfH.js";import{C as aa}from"./chevron-left-B0DRxxlW.js";import{C as ea}from"./chevron-right-FAfa_QAd.js";import{X as E}from"./x-DpsTIIWE.js";import{L as sa}from"./lock-E-Ocy_GT.js";const ta=w("ShieldCheck",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);const ra=w("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]);const ia=w("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]),fa=()=>{const[C,P]=r.useState([]),[z,u]=r.useState(!0),[m,M]=r.useState(""),[o,x]=r.useState(1),[R,A]=r.useState(0),[T,c]=r.useState(!1),[$,h]=r.useState(!1),[n,S]=r.useState(null),[j,q]=r.useState(null),[v,_]=r.useState(""),[t,d]=r.useState({email:"",password:"",nama:"",role:"petugas"}),[b,g]=r.useState(!1),{success:p,error:l}=I();r.useEffect(()=>{f()},[o,m]);const f=async()=>{u(!0);try{let e=i.from("profiles").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((o-1)*N,o*N-1);m&&(e=e.or(`nama.ilike.%${m}%,email.ilike.%${m}%`));const{data:s,count:k,error:U}=await e;if(U)throw U;P(s||[]),A(k||0)}catch(e){l("Gagal memuat data user"),console.error(e)}u(!1)},D=X(e=>{M(e),x(1)},300),L=()=>{S(null),d({email:"",password:"",nama:"",role:"petugas"}),c(!0)},G=e=>{S(e),d({email:e.email,password:"",nama:e.nama,role:e.role}),c(!0)},B=async e=>{if(e.preventDefault(),!t.nama||!t.email){l("Nama dan Email harus diisi");return}if(!n&&!t.password){l("Password harus diisi untuk user baru");return}g(!0);try{if(n){const{error:s}=await i.from("profiles").update({nama:t.nama,role:t.role}).eq("id",n.id);if(s)throw s;await i.rpc("log_activity",{p_aksi:"UPDATE_USER",p_details:{email:t.email,role:t.role}}),p("User berhasil diperbarui")}else{const{data:s,error:k}=await i.auth.signUp({email:t.email,password:t.password,options:{data:{nama:t.nama,role:t.role}}});if(k)throw k;await i.rpc("log_activity",{p_aksi:"CREATE_USER",p_details:{email:t.email,role:t.role}}),p("User baru berhasil ditambahkan")}c(!1),f()}catch(s){l(s.message||"Gagal menyimpan user"),console.error(s)}g(!1)},F=async e=>{try{const{error:s}=await i.from("profiles").update({is_active:!e.is_active}).eq("id",e.id);if(s)throw s;p(e.is_active?"User dinonaktifkan":"User diaktifkan"),f()}catch(s){l("Gagal mengubah status user"),console.error(s)}},H=async e=>{if(confirm(`Hapus user ${e.nama} (${e.email})?

Tindakan ini tidak dapat dibatalkan. Riwayat aktivitas user ini akan tetap ada namun tanpa nama.`)){u(!0);try{const{error:s}=await i.rpc("delete_user_by_admin",{target_user_id:e.id});if(s)throw s;await i.rpc("log_activity",{p_aksi:"DELETE_USER",p_details:{email:e.email,nama:e.nama}}),p(`User ${e.nama} berhasil dihapus`),f()}catch(s){l(s.message||"Gagal menghapus user"),console.error(s),u(!1)}}},y=Math.ceil(R/N);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"page-header",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"Manajemen User"}),a.jsx("p",{className:"page-subtitle",children:"Kelola akun pengguna dan hak akses"})]}),a.jsxs("button",{className:"btn btn-primary",onClick:L,children:[a.jsx(V,{size:18}),"Tambah User"]})]})}),a.jsxs("div",{className:"page-content",children:[a.jsx("div",{className:"card mb-lg",children:a.jsx("div",{className:"card-body",children:a.jsxs("div",{className:"search-box",children:[a.jsx(Q,{className:"search-box-icon",size:18}),a.jsx("input",{type:"text",className:"form-input",placeholder:"Cari berdasarkan nama atau email...",onChange:e=>D(e.target.value)})]})})}),a.jsxs("div",{className:"card",children:[a.jsx("div",{className:"table-container",children:a.jsxs("table",{className:"table",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Nama"}),a.jsx("th",{children:"Email"}),a.jsx("th",{children:"Role"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Dibuat"}),a.jsx("th",{style:{width:150},children:"Aksi"})]})}),a.jsx("tbody",{children:z?[...Array(5)].map((e,s)=>a.jsx("tr",{children:a.jsx("td",{colSpan:6,children:a.jsx("div",{className:"skeleton skeleton-text"})})},s)):C.length===0?a.jsx("tr",{children:a.jsx("td",{colSpan:6,children:a.jsxs("div",{className:"empty-state",children:[a.jsx(W,{className:"empty-state-icon"}),a.jsx("p",{className:"empty-state-title",children:"Tidak ada data"}),a.jsx("p",{className:"empty-state-description",children:m?"Tidak ditemukan user dengan kata kunci tersebut":"Belum ada data user"})]})})}):C.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsxs("div",{className:"flex items-center gap-md",children:[a.jsx("div",{className:"user-avatar",style:{background:e.role==="admin"?"linear-gradient(135deg, var(--primary-500), var(--primary-700))":"var(--gray-300)",color:e.role==="admin"?"white":"var(--gray-700)"},children:e.nama?.charAt(0).toUpperCase()||"U"}),a.jsx("span",{className:"font-medium",children:e.nama})]})}),a.jsx("td",{children:e.email}),a.jsx("td",{children:a.jsx("span",{className:`badge ${e.role==="admin"?"badge-primary":"badge-gray"}`,children:e.role==="admin"?a.jsxs(a.Fragment,{children:[a.jsx(ta,{size:12})," Admin"]}):a.jsxs(a.Fragment,{children:[a.jsx(Y,{size:12})," Petugas"]})})}),a.jsx("td",{children:a.jsx("span",{className:`badge ${e.is_active?"badge-success":"badge-error"}`,children:e.is_active?"Aktif":"Nonaktif"})}),a.jsx("td",{children:K(e.created_at)}),a.jsx("td",{children:a.jsxs("div",{className:"table-actions",children:[a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:e.is_active?"Nonaktifkan":"Aktifkan",onClick:()=>F(e),children:e.is_active?a.jsx(ia,{size:16}):a.jsx(ra,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Edit",onClick:()=>G(e),children:a.jsx(J,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Reset Password",onClick:()=>{q(e),_(""),h(!0)},style:{color:"var(--warning)"},children:a.jsx(Z,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Hapus",onClick:()=>H(e),style:{color:"var(--error)"},children:a.jsx(O,{size:16})})]})})]},e.id))})]})}),y>1&&a.jsx("div",{className:"card-footer",children:a.jsxs("div",{className:"pagination",children:[a.jsx("button",{className:"pagination-btn",disabled:o===1,onClick:()=>x(e=>e-1),children:a.jsx(aa,{size:16})}),[...Array(y)].map((e,s)=>a.jsx("button",{className:`pagination-btn ${o===s+1?"active":""}`,onClick:()=>x(s+1),children:s+1},s)),a.jsx("button",{className:"pagination-btn",disabled:o===y,onClick:()=>x(e=>e+1),children:a.jsx(ea,{size:16})})]})})]})]}),T&&a.jsx("div",{className:"modal-overlay",onClick:()=>c(!1),children:a.jsxs("div",{className:"modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h3",{className:"modal-title",children:n?"Edit User":"Tambah User Baru"}),a.jsx("button",{className:"modal-close",onClick:()=>c(!1),children:a.jsx(E,{size:20})})]}),a.jsxs("form",{onSubmit:B,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nama Lengkap"}),a.jsx("input",{type:"text",className:"form-input",value:t.nama,onChange:e=>d({...t,nama:e.target.value}),placeholder:"Masukkan nama lengkap",required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Email"}),a.jsx("input",{type:"email",className:"form-input",value:t.email,onChange:e=>d({...t,email:e.target.value}),placeholder:"nama@rumahsakit.com",disabled:!!n,required:!0}),n&&a.jsx("p",{className:"form-hint",children:"Email tidak dapat diubah"})]}),!n&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Password"}),a.jsx("input",{type:"password",className:"form-input",value:t.password,onChange:e=>d({...t,password:e.target.value}),placeholder:"Minimal 6 karakter",minLength:6,required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Role"}),a.jsxs("select",{className:"form-input form-select",value:t.role,onChange:e=>d({...t,role:e.target.value}),children:[a.jsx("option",{value:"petugas",children:"Petugas"}),a.jsx("option",{value:"admin",children:"Admin"})]})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>c(!1),children:"Batal"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:b,children:b?"Menyimpan...":"Simpan"})]})]})]})}),$&&a.jsx("div",{className:"modal-overlay",onClick:()=>h(!1),children:a.jsxs("div",{className:"modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("h3",{className:"modal-title flex items-center gap-sm",children:[a.jsx(sa,{size:20}),"Reset Password User"]}),a.jsx("button",{className:"modal-close",onClick:()=>h(!1),children:a.jsx(E,{size:20})})]}),a.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),v.length<6){l("Password minimal 6 karakter");return}g(!0);try{const{error:s}=await i.rpc("reset_user_password",{target_user_id:j.id,new_password:v});if(s)throw s;p(`Password untuk ${j.nama} berhasil direset`),h(!1)}catch(s){l(s.message||"Gagal mereset password"),console.error(s)}g(!1)},children:[a.jsxs("div",{className:"modal-body",children:[a.jsx("div",{className:"alert alert-warning mb-md",children:a.jsxs("p",{className:"text-sm",children:["Anda akan mengubah password untuk user ",a.jsx("strong",{children:j?.nama})," (",j?.email,")."]})}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Password Baru"}),a.jsx("input",{type:"password",className:"form-input",value:v,onChange:e=>_(e.target.value),placeholder:"Minimal 6 karakter",minLength:6,required:!0})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>h(!1),children:"Batal"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:b,children:b?"Mereset...":"Reset Password"})]})]})]})})]})};export{fa as default};
