import{c as T,r as c,s as x,j as e}from"./index-BDgF81px.js";import{u as D}from"./useReferenceData-DZKUuJGK.js";import{c as E,f as F,i as L}from"./helpers-nDoE_7O5.js";import{S as I}from"./search-ddN_mJET.js";import{F as _}from"./file-text-DwBTGXLy.js";import{U}from"./user-H6b_2pSt.js";import{C as A}from"./clock-B6Ww70BQ.js";import{M as P}from"./map-pin-CgCR9dCj.js";import{U as $}from"./users-Bh6ioIii.js";const B=T("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]),Z=()=>{const{locations:u,staff:p,loading:g}=D(),[r,h]=c.useState("out"),[f,b]=c.useState([]),[K,k]=c.useState({}),[j,N]=c.useState(!0),[d,S]=c.useState("");c.useEffect(()=>{w();const s=x.channel("files-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"tracer"},i=>{R(i.new)}).subscribe();return()=>{x.removeChannel(s)}},[]);const w=async()=>{N(!0);try{const{data:s}=await x.from("patients").select("id, no_rm, nama, tanggal_lahir"),i=(s||[]).reduce((t,a)=>(t[a.id]=a,t),{});k(i);const{data:o}=await x.from("tracer").select("*").order("created_at",{ascending:!1}),l={};o?.forEach(t=>{l[t.patient_id]||(l[t.patient_id]=t)});const m=(s||[]).map(t=>{const a=l[t.id];return{patientId:t.id,...t,status:a||null}});b(m)}catch(s){console.error("Error fetching files:",s)}N(!1)},R=s=>{b(i=>i.map(o=>o.patientId===s.patient_id?{...o,status:s}:o))},n=c.useMemo(()=>{if(g||j)return{in:[],out:[]};const s=u.reduce((t,a)=>(t[a.id]=a,t),{}),i=t=>{if(!t)return!0;if(t==="hilang")return!1;const a=s[t];return a?a.is_storage:t==="rekam_medis"},o=f.filter(t=>d?t.nama.toLowerCase().includes(d.toLowerCase())||t.no_rm.toLowerCase().includes(d.toLowerCase()):!0),l=[],m=[];return o.forEach(t=>{const a=t.status?.status_lokasi,y=i(a),C=s[a]?.name||a||"Rekam Medis (Default)",z=t.status?.staff_id?p.find(M=>M.id===t.status.staff_id)?.nama:"-",v={...t,locationName:C,staffName:z,time:t.status?.created_at,is_storage:y};y?l.push(v):m.push(v)}),{in:l,out:m}},[f,u,p,d,j,g]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"page-header",children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"page-title",children:"Monitoring Berkas"}),e.jsx("p",{className:"page-subtitle",children:"Posisi dan status berkas rekam medis realtime"})]})})}),e.jsxs("div",{className:"page-content",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-md mb-lg",children:[e.jsxs("div",{className:"card md:col-span-2 flex items-center p-sm",style:{gap:"0.5rem"},children:[e.jsx(I,{className:"text-muted ml-sm",size:20}),e.jsx("input",{type:"text",className:"form-input text-lg",style:{border:"none",boxShadow:"none"},placeholder:"Cari pasien atau No RM...",value:d,onChange:s=>S(s.target.value)})]}),e.jsxs("div",{className:"card flex items-center justify-between p-md bg-blue-50 text-blue-700 border-blue-100",children:[e.jsx("div",{className:"font-semibold",children:"Total Berkas Keluar"}),e.jsx("div",{className:"text-2xl font-bold",children:n.out.length})]})]}),e.jsxs("div",{className:"flex border-b border-gray-200 mb-md",children:[e.jsxs("button",{className:`btn btn-ghost rounded-none border-b-2 transition-colors ${r==="out"?"border-primary text-primary bg-primary-50":"border-transparent text-secondary hover:text-gray-700 hover:bg-gray-50"}`,style:{padding:"0.75rem 1.5rem",borderRadius:"0"},onClick:()=>h("out"),children:["Sedang Dipinjam / Keluar (",n.out.length,")"]}),e.jsxs("button",{className:`btn btn-ghost rounded-none border-b-2 transition-colors ${r==="in"?"border-primary text-primary bg-primary-50":"border-transparent text-secondary hover:text-gray-700 hover:bg-gray-50"}`,style:{padding:"0.75rem 1.5rem",borderRadius:"0"},onClick:()=>h("in"),children:["Tersedia di Rak (",n.in.length,")"]})]}),e.jsx("div",{className:"flex flex-col gap-md",children:(r==="out"?n.out:n.in).length===0?e.jsxs("div",{className:"empty-state py-xl",children:[e.jsx(_,{size:48,className:"empty-state-icon"}),e.jsx("p",{children:"Tidak ada berkas di kategori ini"})]}):(r==="out"?n.out:n.in).map(s=>e.jsx("div",{className:"card hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"card-body flex items-center gap-md",children:[e.jsx("div",{className:`p-3 rounded-full ${r==="out"?"bg-orange-100 text-orange-600":"bg-green-100 text-green-600"}`,children:r==="out"?e.jsx(B,{size:24}):e.jsx(_,{size:24})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-sm mb-xs",children:[e.jsx("span",{className:"font-mono font-bold text-lg bg-gray-100 px-2 py-0.5 rounded text-gray-700",children:s.no_rm}),e.jsx("span",{className:"font-semibold text-lg truncate",children:s.nama})]}),e.jsxs("div",{className:"text-sm text-secondary flex items-center gap-md",children:[e.jsxs("span",{className:"flex items-center gap-xs",children:[e.jsx(U,{size:14})," ",E(s.tanggal_lahir)]}),s.time&&e.jsxs("span",{className:"flex items-center gap-xs",title:L(s.time),children:[e.jsx(A,{size:14})," ",F(s.time)]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-xs text-right min-w-[150px]",children:[e.jsxs("div",{className:"flex items-center gap-xs font-semibold text-gray-800",children:[e.jsx(P,{size:16,className:r==="out"?"text-orange-500":"text-green-500"}),s.locationName]}),r==="out"&&e.jsxs("div",{className:"text-sm text-blue-600 flex items-center gap-xs",children:[e.jsx($,{size:14}),s.staffName||"Tanpa Nama"]})]})]})},s.patientId))})]})]})};export{Z as default};
