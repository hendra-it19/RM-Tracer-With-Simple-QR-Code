import{c as R,e as H,b as I,u as q,a as K,r as i,s as x,j as e}from"./index-BDgF81px.js";import{u as G}from"./useReferenceData-DZKUuJGK.js";import{a as F,c as $,i as J}from"./helpers-nDoE_7O5.js";import{A as O}from"./arrow-left-Bu8PVcYQ.js";import{C as Q}from"./calendar-CtAkWE1q.js";import{U as w}from"./user-H6b_2pSt.js";import{M as V}from"./map-pin-CgCR9dCj.js";import{C as W}from"./clock-B6Ww70BQ.js";import{U as X}from"./users-Bh6ioIii.js";const Y=R("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]),ce=()=>{const{id:o}=H(),p=I(),{profile:P}=q(),{success:L,error:m}=K(),{locations:c,staff:u,loading:D}=G(),[l,C]=i.useState(null),[d,U]=i.useState([]),[E,g]=i.useState(!0),[j,b]=i.useState(!1),[t,N]=i.useState(""),[r,v]=i.useState(""),[h,k]=i.useState("");i.useEffect(()=>{z()},[o]);const z=async()=>{g(!0);try{const{data:s,error:a}=await x.from("patients").select("*").eq("id",o).single();if(a)throw a;C(s),y()}catch(s){console.error("Error fetching data:",s),m("Gagal memuat data pasien")}g(!1)},y=async()=>{const{data:s,error:a}=await x.from("tracer").select(`
                *,
                profiles:petugas_id (nama),
                staff:staff_id (nama)
            `).eq("patient_id",o).order("created_at",{ascending:!1});if(a){console.error("Error fetching history:",a);return}U(s||[])},A=async()=>{const s=c.find(n=>n.id===t),a=s?.is_storage;if(!t){m("Lokasi harus dipilih");return}if(!a&&!r){m("Petugas Pengambil Berkas harus diisi (untuk lokasi non-penyimpanan)");return}b(!0);try{const{error:n}=await x.from("tracer").insert({patient_id:o,status_lokasi:t,staff_id:a?null:r,keterangan:h||null,petugas_id:P.id}).select().single();if(n)throw n;const M=s?.name||t,B=a?"Dikembalikan ke Rak (System)":u.find(T=>T.id===r)?.nama||r;await x.rpc("log_activity",{p_aksi:"UPDATE_STATUS_ADMIN",p_no_rm:l.no_rm,p_details:{status_lokasi:t,location_name:M,staff_name:B,keterangan:h||null,is_storage:!!a}}),L("Status lokasi berhasil diperbarui"),N(""),v(""),k(""),y()}catch(n){console.error("Error updating status:",n),m("Gagal memperbarui status")}b(!1)},_=s=>{const a=c.find(n=>n.id===s);return a?a.name:s},f=i.useMemo(()=>c.find(a=>a.id===t)?.is_storage,[t,c]);if(E||D)return e.jsxs("div",{className:"page-content",children:[e.jsx("div",{className:"skeleton",style:{height:200,marginBottom:20}}),e.jsx("div",{className:"skeleton",style:{height:400}})]});if(!l)return e.jsxs("div",{className:"page-content text-center",children:[e.jsx("h3",{children:"Pasien tidak ditemukan"}),e.jsx("button",{className:"btn btn-primary mt-md",onClick:()=>p("/admin/patients"),children:"Kembali"})]});const S=d.length>0?d[0].status_lokasi:null;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"page-header",children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-sm mb-xs",children:[e.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",onClick:()=>p("/admin/patients"),children:e.jsx(O,{size:20})}),e.jsx("h1",{className:"page-title",children:"Detail Pasien"})]}),e.jsx("p",{className:"page-subtitle ml-xl",children:"Informasi dan riwayat rekam medis"})]})})}),e.jsx("div",{className:"page-content",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-lg",children:[e.jsxs("div",{className:"md:col-span-1 flex flex-col gap-lg",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"mb-md",children:e.jsx("span",{className:"badge badge-primary font-mono text-lg",children:l.no_rm})}),e.jsx("h2",{className:"text-xl font-bold mb-sm",children:l.nama}),e.jsxs("div",{className:"text-secondary flex flex-col gap-xs text-sm",children:[e.jsxs("div",{className:"flex items-center gap-sm",children:[e.jsx(Q,{size:16}),e.jsxs("span",{children:["Lahir: ",F(l.tanggal_lahir)]})]}),e.jsxs("div",{className:"flex items-center gap-sm",children:[e.jsx(w,{size:16}),e.jsxs("span",{children:["Usia: ",$(l.tanggal_lahir)]})]})]}),e.jsxs("div",{className:"mt-lg pt-md border-t border-gray-200",children:[e.jsx("p",{className:"text-sm font-medium text-secondary mb-xs",children:"Lokasi Terakhir"}),S?e.jsxs("div",{className:"flex items-center gap-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-500"}),e.jsx("span",{className:"font-semibold text-lg",children:_(S)})]}):e.jsx("span",{className:"badge badge-gray",children:"Belum ada riwayat"})]})]})}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h3",{className:"card-title text-lg font-semibold flex items-center gap-sm",children:[e.jsx(V,{size:20}),"Update Lokasi"]})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Lokasi Berkas"}),e.jsxs("select",{className:"form-input form-select",value:t,onChange:s=>N(s.target.value),children:[e.jsx("option",{value:"",children:"-- Pilih Lokasi --"}),c.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),!f&&e.jsxs("div",{className:"form-group mt-md",children:[e.jsx("label",{className:"form-label",children:"Petugas Pengambil Berkas"}),e.jsxs("select",{className:"form-input form-select",value:r,onChange:s=>v(s.target.value),children:[e.jsx("option",{value:"",children:"-- Pilih Petugas --"}),u.map(s=>e.jsxs("option",{value:s.id,children:[s.nama," ",s.nip?`(${s.nip})`:""]},s.id))]})]}),f&&e.jsx("div",{className:"alert alert-info mt-md text-sm",children:e.jsxs("div",{className:"flex items-center gap-xs",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),e.jsx("span",{children:"Berkas dikembalikan ke penyimpanan (Staff otomatis)."})]})}),e.jsxs("div",{className:"mt-md",children:[e.jsx("label",{className:"form-label",children:"Keterangan"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Catatan tambahan...",value:h,onChange:s=>k(s.target.value)})]}),e.jsx("button",{className:"btn btn-primary btn-block mt-md",disabled:!t||!f&&!r||j,onClick:A,children:j?"Menyimpan...":"Simpan Perubahan"})]})]})]}),e.jsx("div",{className:"md:col-span-2",children:e.jsxs("div",{className:"card h-full",children:[e.jsxs("div",{className:"card-header flex justify-between items-center",children:[e.jsxs("h3",{className:"card-title text-lg font-semibold flex items-center gap-sm",children:[e.jsx(Y,{size:20}),"Riwayat Perpindahan"]}),e.jsxs("span",{className:"text-sm text-secondary",children:["Total: ",d.length," aktivitas"]})]}),e.jsx("div",{className:"card-body",children:d.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"Belum ada riwayat perpindahan berkas."})}):e.jsx("div",{className:"relative pl-4 border-l-2 border-gray-100 space-y-8",children:d.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -left-[21px] top-1 w-3 h-3 rounded-full border-2 border-white box-content bg-blue-500"}),e.jsxs("div",{className:"flex flex-col gap-xs",children:[e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsx("span",{className:"font-semibold text-blue-600",children:_(s.status_lokasi)}),e.jsxs("span",{className:"text-xs text-secondary flex items-center gap-xs",children:[e.jsx(W,{size:12}),J(s.created_at)]})]}),e.jsxs("div",{className:"text-sm flex flex-col gap-xs mt-xs",children:[s.staff&&e.jsxs("div",{className:"flex items-center gap-xs text-gray-700",children:[e.jsx(X,{size:14}),e.jsxs("span",{children:["Diambil oleh: ",e.jsx("strong",{children:s.staff.nama})]})]}),s.keterangan&&e.jsxs("div",{className:"text-secondary italic",children:['"',s.keterangan,'"']})]}),e.jsxs("div",{className:"text-xs text-muted flex items-center gap-xs mt-xs",children:[e.jsx(w,{size:12}),e.jsxs("span",{children:["Admin Input: ",s.profiles?.nama||"Unknown"]})]})]})]},s.id))})})]})})]})})]})};export{ce as default};
