const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jsQR-DdZS-Yj-.js","assets/index-BDgF81px.js","assets/index-C-qb4WCL.css"])))=>i.map(i=>d[i]);
import{c as G,f as Z,b as ee,u as ae,a as te,r as n,g as se,s as g,j as e,X as ne,_ as re,U as B}from"./index-BDgF81px.js";import{u as ie}from"./useReferenceData-DZKUuJGK.js";import{p as ce,a as le,c as oe}from"./helpers-nDoE_7O5.js";import{C as de}from"./calendar-CtAkWE1q.js";import{M as ue}from"./map-pin-CgCR9dCj.js";import{U as me}from"./users-Bh6ioIii.js";const fe=G("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);const he=G("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),_e=()=>{const L=Z(),V=ee(),{profile:I}=ae(),{success:N,error:c,warning:$}=te(),{locations:f,staff:E}=ie(),[H,y]=n.useState(!1),[r,p]=n.useState(null),[w,x]=n.useState(null),[i,R]=n.useState(""),[d,D]=n.useState(""),[h,C]=n.useState(""),[A,T]=n.useState(!1),[ge,P]=n.useState(null),[v,K]=n.useState(null),l=n.useRef(null),j=n.useRef(null),b=n.useRef(null);n.useEffect(()=>(L.state?.noRm?U(L.state.noRm):m(),()=>{k(),v&&clearTimeout(v)}),[]);const m=async()=>{try{y(!0),p(null),R(""),D(""),C("");const a=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});j.current=a,l.current&&(l.current.srcObject=a,l.current.play(),F())}catch(a){console.error("Camera error:",a),c("Tidak dapat mengakses kamera."),y(!1)}},F=()=>{const a=async()=>{if(l.current&&l.current.readyState===4){if("BarcodeDetector"in window)try{const s=await new BarcodeDetector({formats:["qr_code"]}).detect(l.current);if(s.length>0){k(),U(s[0].rawValue);return}}catch{}try{const t=l.current,s=document.createElement("canvas");s.width=t.videoWidth,s.height=t.videoHeight;const u=s.getContext("2d");u.drawImage(t,0,0,s.width,s.height);const o=u.getImageData(0,0,s.width,s.height),_=await re(()=>import("./jsQR-DdZS-Yj-.js").then(Y=>Y.j),__vite__mapDeps([0,1,2])),S=(_.default||_)(o.data,o.width,o.height,{inversionAttempts:"dontInvert"});S&&(k(),U(S.data))}catch{}}};b.current=setInterval(a,200)},k=()=>{b.current&&(clearInterval(b.current),b.current=null),j.current&&(j.current.getTracks().forEach(a=>a.stop()),j.current=null),y(!1)},{isOnline:O,addToQueue:W}=se(),U=async a=>{const t=ce(a);if(!t){c("QR Code tidak valid"),m();return}if(!O){p({id:"offline-"+t,no_rm:t,nama:`Pasien ${t}`,tanggal_lahir:new Date,offline:!0}),x(null),$("Mode Offline");return}try{const{data:s,error:u}=await g.from("patients").select("*").eq("no_rm",t).single();if(u||!s){c(`Pasien ${t} tidak ditemukan`),m();return}const{data:o}=await g.from("tracer").select("*").eq("patient_id",s.id).order("updated_at",{ascending:!1}).limit(1).single();p(s),x(o?.status_lokasi||null)}catch(s){console.error(s),c("Gagal memuat data"),m()}},q=a=>f.find(t=>t.id===a)?.name||a,X=async()=>{const t=f.find(s=>s.id===i)?.is_storage;if(!i){c("Pilih lokasi tujuan");return}if(!t&&!d){c("Petugas pengambil wajib diisi untuk lokasi ini");return}if(T(!0),!O||r.offline){try{W({type:"SCAN_MUTATION",payload:{patient_id:r.offline?null:r.id,no_rm:r.no_rm,status_lokasi:i,staff_id:t?null:d,keterangan:h||null,petugas_id:I.id}}),N("Disimpan ke antrian offline"),setTimeout(z,1500)}catch{c("Gagal simpan offline")}T(!1);return}try{const{data:s,error:u}=await g.from("tracer").insert({patient_id:r.id,status_lokasi:i,staff_id:t?null:d,keterangan:h||null,petugas_id:I.id}).select().single();if(u)throw u;const o=q(i),_=t?"Dikembalikan ke Rak (System)":E.find(S=>S.id===d)?.nama||d;await g.rpc("log_activity",{p_aksi:"UPDATE_STATUS",p_no_rm:r.no_rm,p_details:{status_lokasi:i,location_name:o,staff_name:_,keterangan:h||null,is_storage:!!t}}),P({id:s.id,patient:r,oldStatus:w,newStatus:i,keterangan:h}),x(i),N(`Status diperbarui ke ${o}`,{duration:B,onUndo:()=>J(s.id,w)});const Q=setTimeout(()=>P(null),B);K(Q),setTimeout(()=>{R(""),D(""),C("")},1e3)}catch(s){console.error(s),c("Gagal update status")}T(!1)},J=async(a,t)=>{try{await g.from("tracer").delete().eq("id",a),x(t),P(null),v&&clearTimeout(v),N("Perubahan dibatalkan")}catch{c("Gagal undo")}},z=()=>{p(null),m()},M=n.useMemo(()=>f.find(t=>t.id===i)?.is_storage,[i,f]);return e.jsx("div",{className:"flex flex-col gap-md",children:H?e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"qr-scanner-container relative overflow-hidden rounded-xl bg-black",children:[e.jsx("video",{ref:l,autoPlay:!0,playsInline:!0,muted:!0,style:{width:"100%"}}),e.jsx("div",{className:"absolute inset-0 border-2 border-white/50 m-12 rounded-lg pointer-events-none"})]}),e.jsxs("div",{className:"text-center mt-4",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:k,children:[e.jsx(ne,{size:18})," Batal"]}),e.jsx("button",{className:"btn btn-outline-primary ml-2",onClick:()=>V("/petugas/search"),children:"Cari Manual"})]})]}):r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"patient-card",children:[e.jsxs("div",{className:"patient-card-header",children:[e.jsx("span",{className:"patient-no-rm",children:r.no_rm}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:z,children:[e.jsx(he,{size:16})," Scan Lagi"]})]}),e.jsx("h2",{className:"patient-name",children:r.nama}),e.jsxs("div",{className:"patient-info-row",children:[e.jsx(de,{size:16})," ",e.jsx("span",{children:le(r.tanggal_lahir)}),e.jsx("span",{children:"â€¢"})," ",e.jsx("span",{children:oe(r.tanggal_lahir)})]}),e.jsxs("div",{className:"mt-2 text-sm text-secondary",children:["Lokasi Saat Ini: ",e.jsx("strong",{children:q(w)||"Belum ada"})]})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label flex items-center gap-2",children:[e.jsx(ue,{size:16})," Lokasi Tujuan"]}),e.jsxs("select",{className:"form-input form-select",value:i,onChange:a=>R(a.target.value),children:[e.jsx("option",{value:"",children:"-- Pilih Lokasi --"}),f.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),!M&&e.jsxs("div",{className:"form-group mt-4",children:[e.jsxs("label",{className:"form-label flex items-center gap-2",children:[e.jsx(me,{size:16})," Petugas Pengambil"]}),e.jsxs("select",{className:"form-input form-select",value:d,onChange:a=>D(a.target.value),children:[e.jsx("option",{value:"",children:"-- Pilih Petugas --"}),E.map(a=>e.jsx("option",{value:a.id,children:a.nama},a.id))]})]}),M&&e.jsx("div",{className:"alert alert-info mt-4 text-sm",children:"Berkas dikembalikan ke ruangan penyimpanan."}),e.jsxs("div",{className:"form-group mt-4",children:[e.jsx("label",{className:"form-label",children:"Keterangan"}),e.jsx("textarea",{className:"form-input",rows:2,value:h,onChange:a=>C(a.target.value),placeholder:"Opsional"})]}),e.jsx("button",{className:"btn btn-primary btn-block mt-4",disabled:!i||!M&&!d||A,onClick:X,children:A?"Menyimpan...":"Simpan Update"})]})})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx(fe,{size:64,className:"mx-auto text-gray-300 mb-4"}),e.jsx("button",{className:"btn btn-primary",onClick:m,children:"Mulai Scan"})]})})};export{_e as default};
