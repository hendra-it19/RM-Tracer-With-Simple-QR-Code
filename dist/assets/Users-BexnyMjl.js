import{c as H,r,a as I,s as l,I as y,j as a,X as U}from"./index-BDgF81px.js";import{a as K,h as X}from"./helpers-nDoE_7O5.js";import{P as V,a as J,T as O,C as Q,b as W}from"./trash-2-BkqsbA9l.js";import{S as Y}from"./search-ddN_mJET.js";import{U as Z}from"./users-Bh6ioIii.js";import{S as aa,K as ea}from"./shield-DXhV8vyJ.js";import{U as sa}from"./user-x-B8rYHboh.js";import{U as ta}from"./user-check-BQTLTD8b.js";import{L as ra}from"./lock-DlIZMi1N.js";const ia=H("ShieldCheck",[["path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10",key:"1irkt0"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),xa=()=>{const[w,E]=r.useState([]),[P,m]=r.useState(!0),[h,R]=r.useState(""),[o,x]=r.useState(1),[A,z]=r.useState(0),[M,c]=r.useState(!1),[T,u]=r.useState(!1),[n,_]=r.useState(null),[j,$]=r.useState(null),[N,S]=r.useState(""),[t,d]=r.useState({email:"",password:"",nama:"",role:"petugas"}),[b,g]=r.useState(!1),{success:p,error:i}=I();r.useEffect(()=>{f()},[o,h]);const f=async()=>{m(!0);try{let e=l.from("profiles").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((o-1)*y,o*y-1);h&&(e=e.or(`nama.ilike.%${h}%,email.ilike.%${h}%`));const{data:s,count:k,error:C}=await e;if(C)throw C;E(s||[]),z(k||0)}catch(e){i("Gagal memuat data user"),console.error(e)}m(!1)},D=X(e=>{R(e),x(1)},300),L=()=>{_(null),d({email:"",password:"",nama:"",role:"petugas"}),c(!0)},q=e=>{_(e),d({email:e.email,password:"",nama:e.nama,role:e.role}),c(!0)},G=async e=>{if(e.preventDefault(),!t.nama||!t.email){i("Nama dan Email harus diisi");return}if(!n&&!t.password){i("Password harus diisi untuk user baru");return}g(!0);try{if(n){const{error:s}=await l.from("profiles").update({nama:t.nama,role:t.role}).eq("id",n.id);if(s)throw s;await l.rpc("log_activity",{p_aksi:"UPDATE_USER",p_details:{email:t.email,role:t.role}}),p("User berhasil diperbarui")}else{const{data:s,error:k}=await l.auth.signUp({email:t.email,password:t.password,options:{data:{nama:t.nama,role:t.role}}});if(k)throw k;await l.rpc("log_activity",{p_aksi:"CREATE_USER",p_details:{email:t.email,role:t.role}}),p("User baru berhasil ditambahkan")}c(!1),f()}catch(s){i(s.message||"Gagal menyimpan user"),console.error(s)}g(!1)},B=async e=>{try{const{error:s}=await l.from("profiles").update({is_active:!e.is_active}).eq("id",e.id);if(s)throw s;p(e.is_active?"User dinonaktifkan":"User diaktifkan"),f()}catch(s){i("Gagal mengubah status user"),console.error(s)}},F=async e=>{if(confirm(`Hapus user ${e.nama} (${e.email})?

Tindakan ini tidak dapat dibatalkan. Riwayat aktivitas user ini akan tetap ada namun tanpa nama.`)){m(!0);try{const{error:s}=await l.rpc("delete_user_by_admin",{target_user_id:e.id});if(s)throw s;await l.rpc("log_activity",{p_aksi:"DELETE_USER",p_details:{email:e.email,nama:e.nama}}),p(`User ${e.nama} berhasil dihapus`),f(),m(!1)}catch(s){console.error(s),s.message&&s.message.includes("delete_user_by_admin")?i("Gagal: Fungsi hapus user belum dikonfigurasi di database. Hubungi Administrator."):s.message&&s.message.includes("Access denied")?i("Akses ditolak: Hanya admin yang dapat menghapus user."):i(s.message||"Gagal menghapus user"),m(!1)}}},v=Math.ceil(A/y);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"page-header",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"Manajemen User"}),a.jsx("p",{className:"page-subtitle",children:"Kelola akun pengguna dan hak akses"})]}),a.jsxs("button",{className:"btn btn-primary",onClick:L,children:[a.jsx(V,{size:18}),"Tambah User"]})]})}),a.jsxs("div",{className:"page-content",children:[a.jsx("div",{className:"card mb-lg",children:a.jsx("div",{className:"card-body",children:a.jsxs("div",{className:"search-box",children:[a.jsx(Y,{className:"search-box-icon",size:18}),a.jsx("input",{type:"text",className:"form-input",placeholder:"Cari berdasarkan nama atau email...",onChange:e=>D(e.target.value)})]})})}),a.jsxs("div",{className:"card",children:[a.jsx("div",{className:"table-container",children:a.jsxs("table",{className:"table",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Nama"}),a.jsx("th",{children:"Email"}),a.jsx("th",{children:"Role"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Dibuat"}),a.jsx("th",{style:{width:150},children:"Aksi"})]})}),a.jsx("tbody",{children:P?[...Array(5)].map((e,s)=>a.jsx("tr",{children:a.jsx("td",{colSpan:6,children:a.jsx("div",{className:"skeleton skeleton-text"})})},s)):w.length===0?a.jsx("tr",{children:a.jsx("td",{colSpan:6,children:a.jsxs("div",{className:"empty-state",children:[a.jsx(Z,{className:"empty-state-icon"}),a.jsx("p",{className:"empty-state-title",children:"Tidak ada data"}),a.jsx("p",{className:"empty-state-description",children:h?"Tidak ditemukan user dengan kata kunci tersebut":"Belum ada data user"})]})})}):w.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsxs("div",{className:"flex items-center gap-md",children:[a.jsx("div",{className:"user-avatar",style:{background:e.role==="admin"?"linear-gradient(135deg, var(--primary-500), var(--primary-700))":"var(--gray-300)",color:e.role==="admin"?"white":"var(--gray-700)"},children:e.nama?.charAt(0).toUpperCase()||"U"}),a.jsx("span",{className:"font-medium",children:e.nama})]})}),a.jsx("td",{children:e.email}),a.jsx("td",{children:a.jsx("span",{className:`badge ${e.role==="admin"?"badge-primary":"badge-gray"}`,children:e.role==="admin"?a.jsxs(a.Fragment,{children:[a.jsx(ia,{size:12})," Admin"]}):a.jsxs(a.Fragment,{children:[a.jsx(aa,{size:12})," Petugas"]})})}),a.jsx("td",{children:a.jsx("span",{className:`badge ${e.is_active?"badge-success":"badge-error"}`,children:e.is_active?"Aktif":"Nonaktif"})}),a.jsx("td",{children:K(e.created_at)}),a.jsx("td",{children:a.jsxs("div",{className:"table-actions",children:[a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:e.is_active?"Nonaktifkan":"Aktifkan",onClick:()=>B(e),children:e.is_active?a.jsx(sa,{size:16}):a.jsx(ta,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Edit",onClick:()=>q(e),children:a.jsx(J,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Reset Password",onClick:()=>{$(e),S(""),u(!0)},style:{color:"var(--warning)"},children:a.jsx(ea,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Hapus",onClick:()=>F(e),style:{color:"var(--error)"},children:a.jsx(O,{size:16})})]})})]},e.id))})]})}),v>1&&a.jsx("div",{className:"card-footer",children:a.jsxs("div",{className:"pagination",children:[a.jsx("button",{className:"pagination-btn",disabled:o===1,onClick:()=>x(e=>e-1),children:a.jsx(Q,{size:16})}),[...Array(v)].map((e,s)=>a.jsx("button",{className:`pagination-btn ${o===s+1?"active":""}`,onClick:()=>x(s+1),children:s+1},s)),a.jsx("button",{className:"pagination-btn",disabled:o===v,onClick:()=>x(e=>e+1),children:a.jsx(W,{size:16})})]})})]})]}),M&&a.jsx("div",{className:"modal-overlay",onClick:()=>c(!1),children:a.jsxs("div",{className:"modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h3",{className:"modal-title",children:n?"Edit User":"Tambah User Baru"}),a.jsx("button",{className:"modal-close",onClick:()=>c(!1),children:a.jsx(U,{size:20})})]}),a.jsxs("form",{onSubmit:G,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nama Lengkap"}),a.jsx("input",{type:"text",className:"form-input",value:t.nama,onChange:e=>d({...t,nama:e.target.value}),placeholder:"Masukkan nama lengkap",required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Email"}),a.jsx("input",{type:"email",className:"form-input",value:t.email,onChange:e=>d({...t,email:e.target.value}),placeholder:"nama@rumahsakit.com",disabled:!!n,required:!0}),n&&a.jsx("p",{className:"form-hint",children:"Email tidak dapat diubah"})]}),!n&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Password"}),a.jsx("input",{type:"password",className:"form-input",value:t.password,onChange:e=>d({...t,password:e.target.value}),placeholder:"Minimal 6 karakter",minLength:6,required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Role"}),a.jsxs("select",{className:"form-input form-select",value:t.role,onChange:e=>d({...t,role:e.target.value}),children:[a.jsx("option",{value:"petugas",children:"Petugas"}),a.jsx("option",{value:"admin",children:"Admin"})]})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>c(!1),children:"Batal"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:b,children:b?"Menyimpan...":"Simpan"})]})]})]})}),T&&a.jsx("div",{className:"modal-overlay",onClick:()=>u(!1),children:a.jsxs("div",{className:"modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("h3",{className:"modal-title flex items-center gap-sm",children:[a.jsx(ra,{size:20}),"Reset Password User"]}),a.jsx("button",{className:"modal-close",onClick:()=>u(!1),children:a.jsx(U,{size:20})})]}),a.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),N.length<6){i("Password minimal 6 karakter");return}g(!0);try{const{error:s}=await l.rpc("reset_user_password",{target_user_id:j.id,new_password:N});if(s)throw s;p(`Password untuk ${j.nama} berhasil direset`),u(!1)}catch(s){i(s.message||"Gagal mereset password"),console.error(s)}g(!1)},children:[a.jsxs("div",{className:"modal-body",children:[a.jsx("div",{className:"alert alert-warning mb-md",children:a.jsxs("p",{className:"text-sm",children:["Anda akan mengubah password untuk user ",a.jsx("strong",{children:j?.nama})," (",j?.email,")."]})}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Password Baru"}),a.jsx("input",{type:"password",className:"form-input",value:N,onChange:e=>S(e.target.value),placeholder:"Minimal 6 karakter",minLength:6,required:!0})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>u(!1),children:"Batal"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:b,children:b?"Mereset...":"Reset Password"})]})]})]})})]})};export{xa as default};
