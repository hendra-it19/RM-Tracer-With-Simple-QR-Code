import{r as n,a as ea,s as r,I as S,j as a,d as M,X as A,S as C}from"./index-D6bRFg2V.js";import{a as sa,c as ta,g as na,b as Q,d as P,e as la,h as ra}from"./helpers-BFGMH2X3.js";import{P as z,Q as ia}from"./index-BUQowAZh.js";import{P as oa,a as ca,T as da}from"./trash-2-Btg8SXmx.js";import{S as ma}from"./search-CRrIhJ0i.js";import{F as ha}from"./file-text-xnYVbsSq.js";import{E as ua}from"./eye-CBDBdVMq.js";import{Q as xa}from"./qr-code-BHaPqPtL.js";import{C as ja}from"./chevron-left-CMZx6VFW.js";import{C as ga}from"./chevron-right-C8KeAHwD.js";const Pa=()=>{const[i,L]=n.useState([]),[q,E]=n.useState(!0),[h,D]=n.useState(""),[o,g]=n.useState(1),[F,I]=n.useState(0),[X,c]=n.useState(!1),[p,R]=n.useState(null),[t,u]=n.useState({no_rm:"",nama:"",tanggal_lahir:""}),[T,f]=n.useState(!1),[$,b]=n.useState(!1),[x,G]=n.useState(null),[d,N]=n.useState([]),{success:_,error:j}=ea();n.useEffect(()=>{v()},[o,h]);const v=async()=>{E(!0);try{let e=r.from("patients").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((o-1)*S,o*S-1);h&&(e=e.or(`no_rm.ilike.%${h}%,nama.ilike.%${h}%`));const{data:s,count:w,error:m}=await e;if(m)throw m;const Y=s.map(l=>l.id),{data:Z}=await r.from("tracer").select("patient_id, status_lokasi, updated_at").in("patient_id",Y).order("updated_at",{ascending:!1}),y={};Z?.forEach(l=>{y[l.patient_id]||(y[l.patient_id]=l.status_lokasi)});const aa=s.map(l=>({...l,current_status:y[l.id]||null}));L(aa),I(w||0)}catch(e){j("Gagal memuat data pasien"),console.error(e)}E(!1)},B=ra(e=>{D(e),g(1)},300),H=()=>{R(null),u({no_rm:la(),nama:"",tanggal_lahir:""}),c(!0)},U=e=>{R(e),u({no_rm:e.no_rm,nama:e.nama,tanggal_lahir:e.tanggal_lahir||""}),c(!0)},K=async e=>{if(e.preventDefault(),!t.no_rm||!t.nama){j("No RM dan Nama harus diisi");return}f(!0);try{if(p){const{error:s}=await r.from("patients").update({no_rm:t.no_rm,nama:t.nama,tanggal_lahir:t.tanggal_lahir||null,qr_code:P(t.no_rm)}).eq("id",p.id);if(s)throw s;await r.rpc("log_activity",{p_aksi:"UPDATE_PATIENT",p_no_rm:t.no_rm,p_details:{nama:t.nama}}),_("Data pasien berhasil diperbarui")}else{const{error:s}=await r.from("patients").insert({no_rm:t.no_rm,nama:t.nama,tanggal_lahir:t.tanggal_lahir||null,qr_code:P(t.no_rm)});if(s){if(s.code==="23505"){j("Nomor RM sudah terdaftar"),f(!1);return}throw s}await r.rpc("log_activity",{p_aksi:"CREATE_PATIENT",p_no_rm:t.no_rm,p_details:{nama:t.nama}}),_("Pasien baru berhasil ditambahkan")}c(!1),v()}catch(s){j("Gagal menyimpan data pasien"),console.error(s)}f(!1)},V=async e=>{if(confirm(`Hapus pasien ${e.nama} (${e.no_rm})?`))try{const{error:s}=await r.from("patients").delete().eq("id",e.id);if(s)throw s;await r.rpc("log_activity",{p_aksi:"DELETE_PATIENT",p_no_rm:e.no_rm,p_details:{nama:e.nama}}),_("Pasien berhasil dihapus"),v()}catch(s){j("Gagal menghapus pasien"),console.error(s)}},W=e=>{G(e),b(!0)},O=e=>{N(s=>s.find(m=>m.id===e.id)?s.filter(m=>m.id!==e.id):[...s,e])},J=()=>{d.length===i.length?N([]):N([...i])},k=Math.ceil(F/S);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"page-header",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"Manajemen Pasien"}),a.jsx("p",{className:"page-subtitle",children:"Kelola data pasien dan berkas rekam medis"})]}),a.jsxs("div",{className:"flex gap-sm",children:[d.length>0&&a.jsxs(M,{to:"/admin/patients/print",state:{patients:d},className:"btn btn-secondary",children:[a.jsx(z,{size:18}),"Print QR (",d.length,")"]}),a.jsxs("button",{className:"btn btn-primary",onClick:H,children:[a.jsx(oa,{size:18}),"Tambah Pasien"]})]})]})}),a.jsxs("div",{className:"page-content",children:[a.jsx("div",{className:"card mb-lg",children:a.jsx("div",{className:"card-body",children:a.jsxs("div",{className:"search-box",children:[a.jsx(ma,{className:"search-box-icon",size:18}),a.jsx("input",{type:"text",className:"form-input",placeholder:"Cari berdasarkan No RM atau Nama...",onChange:e=>B(e.target.value)})]})})}),a.jsxs("div",{className:"card",children:[a.jsx("div",{className:"table-container",children:a.jsxs("table",{className:"table",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{style:{width:40},children:a.jsx("input",{type:"checkbox",checked:d.length===i.length&&i.length>0,onChange:J,className:"form-check-input"})}),a.jsx("th",{children:"No. RM"}),a.jsx("th",{children:"Nama Pasien"}),a.jsx("th",{children:"Tanggal Lahir"}),a.jsx("th",{children:"Usia"}),a.jsx("th",{children:"Status Lokasi"}),a.jsx("th",{style:{width:150},children:"Aksi"})]})}),a.jsx("tbody",{children:q?[...Array(5)].map((e,s)=>a.jsx("tr",{children:a.jsx("td",{colSpan:7,children:a.jsx("div",{className:"skeleton skeleton-text"})})},s)):i.length===0?a.jsx("tr",{children:a.jsx("td",{colSpan:7,children:a.jsxs("div",{className:"empty-state",children:[a.jsx(ha,{className:"empty-state-icon"}),a.jsx("p",{className:"empty-state-title",children:"Tidak ada data"}),a.jsx("p",{className:"empty-state-description",children:h?"Tidak ditemukan pasien dengan kata kunci tersebut":"Belum ada data pasien"})]})})}):i.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:a.jsx("input",{type:"checkbox",checked:d.some(s=>s.id===e.id),onChange:()=>O(e),className:"form-check-input"})}),a.jsx("td",{children:a.jsx("span",{className:"font-semibold",style:{color:"var(--primary-600)"},children:e.no_rm})}),a.jsx("td",{children:e.nama}),a.jsx("td",{children:sa(e.tanggal_lahir)}),a.jsx("td",{children:ta(e.tanggal_lahir)}),a.jsx("td",{children:e.current_status?a.jsx("span",{className:"badge",style:{backgroundColor:`${Q(e.current_status,C)}20`,color:Q(e.current_status,C)},children:na(e.current_status,C)}):a.jsx("span",{className:"badge badge-gray",children:"Belum ada"})}),a.jsx("td",{children:a.jsxs("div",{className:"table-actions",children:[a.jsx(M,{to:`/admin/patients/${e.id}`,className:"btn btn-icon btn-ghost btn-sm",title:"Lihat Detail",children:a.jsx(ua,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Lihat QR",onClick:()=>W(e),children:a.jsx(xa,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Edit",onClick:()=>U(e),children:a.jsx(ca,{size:16})}),a.jsx("button",{className:"btn btn-icon btn-ghost btn-sm",title:"Hapus",onClick:()=>V(e),style:{color:"var(--error)"},children:a.jsx(da,{size:16})})]})})]},e.id))})]})}),k>1&&a.jsx("div",{className:"card-footer",children:a.jsxs("div",{className:"pagination",children:[a.jsx("button",{className:"pagination-btn",disabled:o===1,onClick:()=>g(e=>e-1),children:a.jsx(ja,{size:16})}),[...Array(k)].map((e,s)=>a.jsx("button",{className:`pagination-btn ${o===s+1?"active":""}`,onClick:()=>g(s+1),children:s+1},s)),a.jsx("button",{className:"pagination-btn",disabled:o===k,onClick:()=>g(e=>e+1),children:a.jsx(ga,{size:16})})]})})]})]}),X&&a.jsx("div",{className:"modal-overlay",onClick:()=>c(!1),children:a.jsxs("div",{className:"modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h3",{className:"modal-title",children:p?"Edit Pasien":"Tambah Pasien Baru"}),a.jsx("button",{className:"modal-close",onClick:()=>c(!1),children:a.jsx(A,{size:20})})]}),a.jsxs("form",{onSubmit:K,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nomor Rekam Medis"}),a.jsx("input",{type:"text",className:"form-input",value:t.no_rm,onChange:e=>u({...t,no_rm:e.target.value}),placeholder:"RM-XXXXXX",required:!0}),!p&&a.jsx("p",{className:"form-hint",children:"Nomor RM digenerate otomatis, bisa diubah manual"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nama Pasien"}),a.jsx("input",{type:"text",className:"form-input",value:t.nama,onChange:e=>u({...t,nama:e.target.value}),placeholder:"Masukkan nama lengkap",required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tanggal Lahir"}),a.jsx("input",{type:"date",className:"form-input",value:t.tanggal_lahir,onChange:e=>u({...t,tanggal_lahir:e.target.value})})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>c(!1),children:"Batal"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:T,children:T?"Menyimpan...":"Simpan"})]})]})]})}),$&&x&&a.jsx("div",{className:"modal-overlay",onClick:()=>b(!1),children:a.jsxs("div",{className:"modal",onClick:e=>e.stopPropagation(),style:{maxWidth:360},children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h3",{className:"modal-title",children:"QR Code"}),a.jsx("button",{className:"modal-close",onClick:()=>b(!1),children:a.jsx(A,{size:20})})]}),a.jsxs("div",{className:"modal-body text-center",children:[a.jsx("div",{className:"qr-code-display",children:a.jsx(ia,{value:P(x.no_rm),size:200,level:"H"})}),a.jsxs("div",{className:"qr-code-info",children:[a.jsx("div",{className:"qr-code-no-rm",children:x.no_rm}),a.jsx("div",{className:"text-secondary",children:x.nama})]})]}),a.jsx("div",{className:"modal-footer",children:a.jsxs("button",{className:"btn btn-primary btn-block",onClick:()=>{N([x]),b(!1)},children:[a.jsx(z,{size:18}),"Cetak QR Code"]})})]})})]})};export{Pa as default};
