import{u as I,r as l,s as C,j as a}from"./index-BDgF81px.js";import{u as E}from"./useReferenceData-DZKUuJGK.js";import{a as j,i as T}from"./helpers-nDoE_7O5.js";import{S as A}from"./search-ddN_mJET.js";import{C as R}from"./clock-B6Ww70BQ.js";import{M as U}from"./map-pin-CgCR9dCj.js";import{F as O}from"./file-text-DwBTGXLy.js";import{U as z}from"./users-Bh6ioIii.js";const W=()=>{const{profile:x}=I(),{locations:y,staff:u}=E(),[p,N]=l.useState([]),[S,h]=l.useState(!0),[n,b]=l.useState("today"),[d,_]=l.useState(""),[o,w]=l.useState(""),[c,D]=l.useState(""),[t,g]=l.useState({start:"",end:""});l.useEffect(()=>{x?.id&&k()},[x,n,d,o,c,t]);const k=async()=>{h(!0);try{let e=C.from("activity_logs").select("*").eq("user_id",x.id).in("aksi",["UPDATE_STATUS","SCAN_QR"]).order("created_at",{ascending:!1}).limit(100);const i=new Date;if(n==="today"){const s=new Date;s.setHours(0,0,0,0),e=e.gte("created_at",s.toISOString())}else if(n==="week"){const s=new Date;s.setDate(s.getDate()-7),e=e.gte("created_at",s.toISOString())}else if(n==="month"){const s=new Date;s.setMonth(s.getMonth()-1),e=e.gte("created_at",s.toISOString())}else if(n==="custom"&&(t.start&&(e=e.gte("created_at",t.start)),t.end)){const s=new Date(t.end);s.setDate(s.getDate()+1),e=e.lt("created_at",s.toISOString())}if(d&&(e=e.ilike("no_rm",`%${d}%`)),o&&(e=e.contains("details",{status_lokasi:o})),c){const s=u.find(r=>r.id===c);s&&(e=e.contains("details",{staff_name:s.nama}))}const{data:f,error:v}=await e;if(v)throw v;const m={};f?.forEach(s=>{const r=j(s.created_at,"yyyy-MM-dd");m[r]||(m[r]=[]),m[r].push(s)}),N(Object.entries(m).map(([s,r])=>({date:s,dateLabel:j(s,"EEEE, dd MMMM yyyy"),items:r})))}catch(e){console.error("Error fetching history:",e)}h(!1)},M=[{value:"today",label:"Hari Ini"},{value:"week",label:"Minggu Ini"},{value:"month",label:"Bulan Ini"},{value:"custom",label:"Range Tanggal"}];return a.jsxs("div",{className:"flex flex-col gap-md",children:[a.jsx("div",{className:"flex gap-sm overflow-x-auto pb-2 scrollbar-hide",children:M.map(e=>a.jsx("button",{className:`btn btn-sm ${n===e.value?"btn-primary":"btn-secondary"}`,onClick:()=>b(e.value),style:{whiteSpace:"nowrap"},children:e.label},e.value))}),a.jsx("div",{className:"card",children:a.jsx("div",{className:"card-body p-sm",children:a.jsxs("div",{className:"flex flex-col gap-sm",children:[a.jsx("div",{className:"flex gap-sm",children:a.jsxs("div",{className:"search-box flex-1",children:[a.jsx(A,{className:"search-box-icon",size:16}),a.jsx("input",{type:"text",className:"form-input form-input-sm",placeholder:"Cari No RM...",value:d,onChange:e=>_(e.target.value)})]})}),n==="custom"&&a.jsxs("div",{className:"flex gap-sm",children:[a.jsx("input",{type:"date",className:"form-input form-input-sm",value:t.start,onChange:e=>g({...t,start:e.target.value}),placeholder:"Mulai"}),a.jsx("input",{type:"date",className:"form-input form-input-sm",value:t.end,onChange:e=>g({...t,end:e.target.value}),placeholder:"Selesai"})]}),a.jsxs("div",{className:"flex gap-sm",children:[a.jsxs("select",{className:"form-input form-input-sm",value:o,onChange:e=>w(e.target.value),style:{width:"50%"},children:[a.jsx("option",{value:"",children:"Semua Lokasi"}),y.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),a.jsxs("select",{className:"form-input form-input-sm",value:c,onChange:e=>D(e.target.value),style:{width:"50%"},children:[a.jsx("option",{value:"",children:"Semua Petugas"}),u.map(e=>a.jsx("option",{value:e.id,children:e.nama},e.id))]})]})]})})}),S?a.jsx("div",{className:"flex justify-center p-lg",children:a.jsx("div",{className:"spinner"})}):p.length===0?a.jsxs("div",{className:"empty-state",children:[a.jsx(R,{size:48,style:{opacity:.3}}),a.jsx("p",{className:"empty-state-title mt-md",children:"Tidak ada data"})]}):a.jsx("div",{className:"flex flex-col gap-lg",children:p.map(e=>a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-semibold text-secondary mb-sm pl-1",children:e.dateLabel}),a.jsx("div",{className:"card",children:a.jsx("div",{style:{padding:0},children:e.items.map((i,f)=>a.jsxs("div",{className:"flex flex-col gap-xs",style:{padding:"var(--spacing-md)",borderBottom:f<e.items.length-1?"1px solid var(--border)":"none"},children:[a.jsxs("div",{className:"flex items-center gap-md",children:[a.jsx("div",{style:{width:40,height:40,borderRadius:"var(--radius-lg)",background:"var(--primary-50)",color:"var(--primary-600)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:i.aksi==="UPDATE_STATUS"?a.jsx(U,{size:18}):a.jsx(O,{size:18})}),a.jsxs("div",{style:{flex:1,minWidth:0},children:[a.jsx("div",{className:"font-medium text-lg",children:i.no_rm}),a.jsx("div",{className:"text-sm font-semibold text-gray-800",children:i.details?.location_name||i.details?.status_lokasi||"Update Status"})]}),a.jsx("div",{className:"text-sm text-muted",children:T(i.created_at).split(", ")[1]})]}),i.details?.staff_name&&a.jsxs("div",{className:"ml-[56px] text-sm text-blue-600 flex items-center gap-xs",children:[a.jsx(z,{size:14}),a.jsxs("span",{children:["Diambil: ",i.details.staff_name]})]})]},i.id))})})]},e.date))})]})};export{W as default};
