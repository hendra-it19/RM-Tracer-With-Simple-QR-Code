const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jsQR-BMw0TFMs.js","assets/index-D6bRFg2V.js","assets/index-CeNto6K6.css"])))=>i.map(i=>d[i]);
import{c as P,f as H,u as W,a as X,r as s,h as J,s as v,j as e,X as Y,S as j,C as Z,_ as ee,U as z}from"./index-D6bRFg2V.js";import{p as ae,a as te,c as ne,b as re,g as D}from"./helpers-BFGMH2X3.js";import{S as se}from"./search-CRrIhJ0i.js";import{C as ie}from"./calendar-D7ttK55D.js";import{M as le}from"./map-pin-tTz-FRlL.js";const A=P("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);const ce=P("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),ge=()=>{const E=H(),{profile:N}=W(),{success:w,error:c,warning:O}=X(),[Q,C]=s.useState(!1),[r,k]=s.useState(null),[o,d]=s.useState(null),[f,u]=s.useState(null),[m,p]=s.useState(""),[$,R]=s.useState(!1),[oe,b]=s.useState(null),[S,M]=s.useState(null),i=s.useRef(null),y=s.useRef(null),_=s.useRef(null);s.useEffect(()=>(E.state?.noRm?T(E.state.noRm):h(),()=>{g(),S&&clearTimeout(S)}),[]);const h=async()=>{try{C(!0),k(null),u(null),p("");const a=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});y.current=a,i.current&&(i.current.srcObject=a,i.current.play(),V())}catch(a){console.error("Camera error:",a),c("Tidak dapat mengakses kamera. Pastikan izin kamera diaktifkan."),C(!1)}},V=()=>{const a=async()=>{if(i.current&&i.current.readyState===4){if("BarcodeDetector"in window)try{const n=await new BarcodeDetector({formats:["qr_code"]}).detect(i.current);if(n.length>0){const l=n[0].rawValue;g(),T(l);return}}catch{}try{const t=i.current,n=document.createElement("canvas");n.width=t.videoWidth,n.height=t.videoHeight;const l=n.getContext("2d");l.drawImage(t,0,0,n.width,n.height);const x=l.getImageData(0,0,n.width,n.height),L=await ee(()=>import("./jsQR-BMw0TFMs.js").then(F=>F.j),__vite__mapDeps([0,1,2])),q=(L.default||L)(x.data,x.width,x.height,{inversionAttempts:"dontInvert"});q&&(g(),T(q.data))}catch(t){console.error("jsQR error:",t)}}};_.current=setInterval(a,200)},g=()=>{_.current&&(clearInterval(_.current),_.current=null),y.current&&(y.current.getTracks().forEach(a=>a.stop()),y.current=null),C(!1)},{isOnline:U,addToQueue:B}=J(),T=async a=>{const t=ae(a);if(!t){c("QR Code tidak valid"),h();return}if(!U){k({id:"offline-"+t,no_rm:t,nama:`Pasien ${t}`,tanggal_lahir:new Date,offline:!0}),d(null),O("Mode Offline: Data pasien tidak dapat diverifikasi penuh");return}try{const{data:n,error:l}=await v.from("patients").select("*").eq("no_rm",t).single();if(l||!n){c(`Pasien dengan No RM ${t} tidak ditemukan`),h();return}const{data:x}=await v.from("tracer").select("*").eq("patient_id",n.id).order("updated_at",{ascending:!1}).limit(1).single();k(n),d(x?.status_lokasi||null)}catch(n){console.error("Error fetching patient:",n),c("Gagal memuat data pasien"),h()}},G=async a=>{if(!(!r||!N)){if(u(a),R(!0),!U||r.offline){try{B({type:"SCAN_MUTATION",payload:{patient_id:r.offline?null:r.id,no_rm:r.no_rm,status_lokasi:a,keterangan:m||null,petugas_id:N.id}}),b({id:"offline-temp",patient:r,oldStatus:o,newStatus:a,keterangan:m}),d(a),w(`Disimpan ke antrian offline: ${D(a,j)}`),setTimeout(()=>{u(null),p(""),I()},1500)}catch(t){console.error("Error queuing offline item:",t),c("Gagal menyimpan ke antrian offline")}R(!1);return}try{const{data:t,error:n}=await v.from("tracer").insert({patient_id:r.id,status_lokasi:a,keterangan:m||null,petugas_id:N.id}).select().single();if(n)throw n;await v.rpc("log_activity",{p_aksi:"UPDATE_STATUS",p_no_rm:r.no_rm,p_details:{status_lokasi:a,keterangan:m||null,previous_status:o}}),b({id:t.id,patient:r,oldStatus:o,newStatus:a,keterangan:m}),d(a),w(`Status diperbarui ke ${D(a,j)}`,{duration:z,onUndo:()=>K(t.id,o)});const l=setTimeout(()=>{b(null)},z);M(l),setTimeout(()=>{u(null),p("")},1e3)}catch(t){console.error("Error updating status:",t),c("Gagal memperbarui status"),u(null)}R(!1)}},K=async(a,t)=>{try{await v.from("tracer").delete().eq("id",a),d(t),b(null),S&&(clearTimeout(S),M(null)),w("Perubahan dibatalkan")}catch(n){console.error("Error undoing:",n),c("Gagal membatalkan perubahan")}},I=()=>{k(null),d(null),u(null),p(""),h()};return e.jsx("div",{className:"flex flex-col gap-md",children:Q?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"qr-scanner-container",children:[e.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,muted:!0,style:{width:"100%",borderRadius:"var(--radius-xl)"}}),e.jsx("div",{className:"qr-scanner-overlay",children:e.jsx("div",{className:"qr-scanner-frame"})})]}),e.jsxs("div",{className:"text-center flex flex-col items-center gap-sm mt-md",children:[e.jsx("p",{className:"text-secondary",children:"Arahkan kamera ke QR Code"}),e.jsxs("div",{className:"flex gap-md",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:g,children:[e.jsx(Y,{size:18}),"Batal"]}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>{g(),window.location.href="/petugas/search"},children:[e.jsx(se,{size:18}),"Cari Manual"]})]})]})]}):r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"patient-card",children:[e.jsxs("div",{className:"patient-card-header",children:[e.jsx("span",{className:"patient-no-rm",children:r.no_rm}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:I,children:[e.jsx(ce,{size:16}),"Scan Lagi"]})]}),e.jsx("h2",{className:"patient-name",children:r.nama}),e.jsxs("div",{className:"patient-info-row",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:te(r.tanggal_lahir)}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:ne(r.tanggal_lahir)})]}),o&&e.jsxs("div",{className:"patient-current-status",children:[e.jsx("div",{className:"patient-current-status-dot",style:{backgroundColor:re(o,j)}}),e.jsxs("span",{className:"patient-current-status-label",children:["Lokasi saat ini: ",D(o,j)]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"form-label mb-md",children:[e.jsx(le,{size:16,style:{display:"inline",marginRight:4}}),"Pilih Lokasi Tujuan"]}),e.jsx("div",{className:"status-buttons",children:j.map(a=>e.jsxs("button",{className:`status-btn ${f===a.value?"active":""}`,onClick:()=>G(a.value),disabled:$||f===a.value,style:{borderColor:f===a.value?a.color:void 0,background:f===a.value?`${a.color}10`:void 0},children:[e.jsx("div",{className:"status-btn-indicator",style:{backgroundColor:a.color}}),e.jsx("div",{children:e.jsx("div",{className:"status-btn-label",children:a.label})}),f===a.value&&e.jsx(Z,{size:20,style:{color:a.color,marginLeft:"auto"}})]},a.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Keterangan (Opsional)"}),e.jsx("textarea",{className:"form-input form-textarea",value:m,onChange:a=>p(a.target.value),placeholder:"Tambahkan catatan jika diperlukan...",rows:2})]})]}):e.jsxs("div",{className:"text-center",style:{padding:"var(--spacing-2xl)"},children:[e.jsx(A,{size:64,style:{color:"var(--text-muted)",marginBottom:16}}),e.jsx("h3",{children:"Memuat Scanner..."}),e.jsx("p",{className:"text-secondary",children:"Izinkan akses kamera untuk memulai scan"}),e.jsxs("button",{className:"btn btn-primary mt-lg",onClick:h,children:[e.jsx(A,{size:18}),"Mulai Scan"]})]})})};export{ge as default};
